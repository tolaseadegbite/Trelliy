<div class=""
     data-controller="search-filter"
     data-action="click@window->search-filter#closeOnClickOutside">

  <%# Button to toggle the visibility of the filters %>
  <button type="button" class="btn btn--subtle mbe-4" data-action="search-filter#toggle">
    <span class="icon icon--search"></span>
    <span>Search events</span>
  </button>

  <div class="hide card" data-search-filter-target="filters">
    <%= search_form_for @q, url: follow_up_tasks_path do |f| %>
      <div class="grid grid-cols-1 grid-cols-2@sm grid-cols-2@md grid-cols-3@lg gap-4 mbe-4">

        <div>
          <%= f.search_field :contact_first_name_or_contact_last_name_or_contact_email_or_event_name_cont,
                              class: "input i-full mbs-2",
                              placeholder: "Search by name, email, or event..." %>
        </div>

        <div>
          <%= f.collection_select :invitation_event_id_eq,
                            @filterable_events,
                            :id,
                            :name,
                            { include_blank: 'Filter by Events' },
                            { class: "i-full mbs-2", data: { controller: "combobox" } } %>
        </div>

        <div>
          <%# --- FILTER LINK LOGIC --- %>
          <%
            # This logic to build the base parameters is correct.
            base_params = params.fetch(:q, {}).except(:due_at_lt, :due_at_gteq, :due_at_lteq, :page).permit!
            
            # Helper variables to determine the active state.
            q_params = params.fetch(:q, {})
            is_all_active = !q_params.key?("due_at_lt") && !q_params.key?("due_at_gteq")
            is_overdue_active = q_params.key?("due_at_lt")
            is_today_active = q_params.key?("due_at_gteq")
          %>

          <div class="flex items-center gap justify-end mbs-2">

            <%= link_to "All", follow_up_tasks_path(q: base_params),
                        class: "btn #{is_all_active ? 'btn--primary' : 'btn--secondary border border-main'}" %>
            
            <%= link_to "Overdue", follow_up_tasks_path(q: base_params.merge(due_at_lt: Time.current)),
                        class: "btn text-red-400 #{is_overdue_active ? 'btn--primary' : 'btn--secondary border border-main'}" %>

            <%= link_to "Due Today", follow_up_tasks_path(q: base_params.merge(
                                                              due_at_gteq: Time.current.beginning_of_day,
                                                              due_at_lteq: Time.current.end_of_day
                                                            )),
                        class: "btn #{is_today_active ? 'btn--primary' : 'btn--secondary border border-main'}" %>
          </div>
        </div>
      </div>
      
      <%# --- Form Action Buttons --- %>
      <div class="flex items-center justify-end gap mbs-4">
        <%= link_to "Reset All", follow_up_tasks_path, class: "btn" if params[:q].present? %>
        <%= f.submit "Search", class: "btn" %>
      </div>
    <% end %>
  </div>
</div>